---
import { getImage } from 'astro:assets';
import julianRede from '../assets/julian-rede.jpg';

interface Props {
  videoId?: string;
  title?: string;
}

const {
  videoId = "",
  title = "Meine Vision für Straubing"
} = Astro.props;

// Optimize poster image
const poster = await getImage({
  src: julianRede,
  width: 1280,
  format: 'webp'
});

const hasVideo = videoId && videoId !== "" && videoId !== "PLACEHOLDER";
---

<section id="video" class="relative">
  <!-- Angled top edge -->
  <div class="mutig-angle-top bg-white pt-16 pb-12 lg:pt-24 lg:pb-20">
    <div class="max-w-4xl mx-auto px-4">

      <h2 class="text-2xl sm:text-3xl lg:text-4xl font-headline text-dark uppercase text-center mb-2" data-animate>
        {title}
      </h2>
      <p class="text-center text-gray text-sm sm:text-base mb-8" data-animate>
        Schau dir an, wofür ich stehe.
      </p>

      <!-- Video Container -->
      <div
        class="video-container relative aspect-video bg-dark overflow-hidden shadow-2xl"
        data-video-id={videoId}
        data-animate
      >
        <!-- Poster/Thumbnail -->
        <div class:list={["video-poster absolute inset-0", hasVideo ? "group cursor-pointer" : "cursor-default"]}>
          <img
            src={poster.src}
            alt="Video Vorschau - Julian Guggeis spricht"
            class="w-full h-full object-cover object-[center_30%] transition-transform duration-500 group-hover:scale-105"
            loading="lazy"
          />

          <!-- Gradient Overlay -->
          <div class="absolute inset-0 bg-gradient-to-t from-dark/60 via-dark/20 to-transparent"></div>

          <!-- Play Button -->
          <button
            class:list={[
              "play-button absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 lg:w-24 lg:h-24 bg-primary border-0 rounded-full flex items-center justify-center text-white transition-transform duration-300 focus-visible:outline-none focus-visible:ring-4 focus-visible:ring-primary/50",
              hasVideo ? "cursor-pointer hover:scale-110" : "cursor-default opacity-60"
            ]}
            aria-label="Video abspielen"
            aria-disabled={!hasVideo}
            disabled={!hasVideo}
          >
            <svg class="w-8 h-8 lg:w-10 lg:h-10 ml-1" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>

          <!-- Text Overlay -->
          <div class="absolute bottom-0 left-0 right-0 p-6 lg:p-8">
            <p class="text-white font-headline uppercase text-lg lg:text-xl tracking-wide">
              {hasVideo ? "Video ansehen" : "Video kommt bald"}
            </p>
            {hasVideo && (
              <p class="text-white/70 text-sm mt-1">
                Mit Klick akzeptierst du YouTube-Cookies
              </p>
            )}
          </div>
        </div>

        <!-- YouTube iframe container (injected on click) -->
        <div class="video-frame"></div>
      </div>

      {!hasVideo && (
        <p class="text-sm text-gray text-center mt-4">
          Das Video kommt bald. Folge mir auf Instagram f&uuml;r Updates.
        </p>
      )}

      <!-- CTA below video -->
      <div class="text-center mt-8" data-animate>
        <a href="#kontakt" class="btn btn-primary w-full sm:w-auto">
          Lass uns reden
        </a>
      </div>

    </div>
  </div>
</section>

<style>
  .video-container {
    box-shadow:
      0 25px 50px -12px rgba(0,0,0,0.25),
      0 0 0 1px rgba(0,0,0,0.05);
  }

  .play-button {
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      box-shadow: 0 0 0 0 rgba(227, 0, 27, 0.5);
    }
    50% {
      box-shadow: 0 0 0 20px rgba(227, 0, 27, 0);
    }
  }

  .video-poster.hidden {
    display: none;
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .play-button {
      animation: none;
    }

    .video-poster img {
      transition: none;
    }
  }
</style>

<script>
  document.querySelectorAll('.video-container').forEach(container => {
    const poster = container.querySelector('.video-poster') as HTMLElement;
    const frame = container.querySelector('.video-frame') as HTMLElement;
    const videoId = container.getAttribute('data-video-id');

    if (!videoId || videoId === '' || videoId === 'PLACEHOLDER') {
      return;
    }

    poster?.addEventListener('click', () => {
      // Create YouTube iframe with privacy-enhanced mode
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0&modestbranding=1`;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;
      iframe.title = 'YouTube Video Player';
      iframe.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;border:0;';

      // Add iframe and hide poster
      frame.appendChild(iframe);
      poster.classList.add('hidden');
    });
  });
</script>
