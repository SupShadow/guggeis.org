---
// Termine-Sektion für Wahlkampfveranstaltungen
// Lädt Termine von externer API (GitHub Pages)
const API_URL = "https://supshadow.github.io/spd-straubing-kampagne-termine/api/termine.json";
---

<section id="termine" class="relative bg-secondary py-16 lg:py-28" data-animate>
  <!-- Angled top edge -->
  <div class="absolute top-0 left-0 right-0 h-16 bg-white transform -skew-y-2 origin-top-right -translate-y-8"></div>

  <div class="max-w-7xl mx-auto px-6 lg:px-12">
    <div class="text-center mb-12">
      <span class="inline-block text-accent-yellow font-headline text-sm uppercase tracking-widest mb-4">
        Termine
      </span>
      <h2 class="text-3xl sm:text-4xl lg:text-5xl text-white mb-6">
        Alle Termine
      </h2>
      <p class="text-base sm:text-lg text-white max-w-2xl mx-auto">
        Persönliche Begegnungen sind mir wichtig. Hier findest du alle kommenden Veranstaltungen im Überblick.
      </p>
    </div>

    <!-- Nächstes Treffen (nur Mobile) -->
    <div class="md:hidden mb-10">
      <div class="bg-white/10 backdrop-blur-sm p-5 border border-white/10">
        <p class="text-accent-yellow font-headline text-xs uppercase tracking-widest mb-3">
          Nächstes Treffen
        </p>
        <div id="next-event-mobile-loading" class="text-white/90 flex items-center gap-3" role="status">
          <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Termine werden geladen...</span>
        </div>

        <div id="next-event-mobile-card" class="hidden">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 bg-white text-dark px-3 py-2 text-center">
              <span id="next-event-mobile-day" class="block text-2xl font-headline leading-none">--</span>
              <span id="next-event-mobile-month" class="block text-[10px] uppercase tracking-widest">---</span>
            </div>
            <div>
              <h3 id="next-event-mobile-title" class="font-headline text-white uppercase text-lg mb-1"></h3>
              <p id="next-event-mobile-meta" class="text-white/90 text-sm mb-2"></p>
              <p id="next-event-mobile-desc" class="text-white/80 text-sm"></p>
            </div>
          </div>
        </div>

        <div id="next-event-mobile-fallback" class="hidden text-white/90">
          <p class="mb-3">
            Termine folgen. Ich halte dich auf dem Laufenden.
          </p>
          <a
            href="https://instagram.com/jguggeis"
            target="_blank"
            rel="noopener noreferrer"
            class="text-accent-yellow hover:text-white transition-colors text-sm font-medium"
          >
            @jguggeis auf Instagram
          </a>
        </div>
      </div>
    </div>

    <!-- Termine Container - wird via JavaScript gefüllt -->
    <div id="termine-container" aria-live="polite" aria-atomic="true">
      <!-- Lade-Indikator -->
      <div id="termine-loading" class="text-center py-8" role="status">
        <div class="inline-flex items-center gap-3 text-white/90">
          <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Termine werden geladen...</span>
        </div>
      </div>

      <!-- Termine Grid (initial versteckt) -->
      <div id="termine-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 hidden" role="list" aria-label="Veranstaltungen"></div>

      <!-- Fallback wenn keine Termine -->
      <div id="termine-fallback" class="text-center py-12 hidden">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-white/10 rounded-full mb-6">
          <svg class="w-8 h-8 text-accent-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <h3 class="text-xl font-headline text-white uppercase mb-3">
          Termine folgen
        </h3>
        <p class="text-white max-w-md mx-auto">
          Die Wahlkampf-Termine werden hier veröffentlicht, sobald sie feststehen.
          Folge mir auf Instagram für aktuelle Updates!
        </p>
        <a
          href="https://instagram.com/jguggeis"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 mt-6 text-accent-yellow hover:text-white transition-colors"
          aria-label="@jguggeis auf Instagram folgen"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.218 2.427.465a4.902 4.902 0 011.772 1.153 4.902 4.902 0 011.153 1.772c.247.636.416 1.363.465 2.427.048 1.067.06 1.407.06 4.123v.08c0 2.643-.012 2.987-.06 4.043-.049 1.064-.218 1.791-.465 2.427a4.902 4.902 0 01-1.153 1.772 4.902 4.902 0 01-1.772 1.153c-.636.247-1.363.416-2.427.465-1.067.048-1.407.06-4.123.06h-.08c-2.643 0-2.987-.012-4.043-.06-1.064-.049-1.791-.218-2.427-.465a4.902 4.902 0 01-1.772-1.153 4.902 4.902 0 01-1.153-1.772c-.247-.636-.416-1.363-.465-2.427-.047-1.024-.06-1.379-.06-3.808v-.63c0-2.43.013-2.784.06-3.808.049-1.064.218-1.791.465-2.427a4.902 4.902 0 011.153-1.772A4.902 4.902 0 015.45 2.525c.636-.247 1.363-.416 2.427-.465C8.901 2.013 9.256 2 11.685 2h.63z" />
          </svg>
          @jguggeis folgen
        </a>
      </div>
    </div>
  </div>
</section>

<script define:vars={{ API_URL }}>
  // HTML-Escaping zum Schutz vor XSS bei API-Daten
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // iCal-Datei generieren
  function generateICalEvent(termin) {
    const startDate = new Date(`${termin.datum}T${termin.uhrzeit || '00:00'}:00`);
    const endDate = new Date(startDate.getTime() + 2 * 60 * 60 * 1000); // +2h default

    const formatICalDate = (date) => {
      return date.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}/, '');
    };

    const uid = `${termin.datum}-${termin.uhrzeit || 'allday'}@guggeis.org`;
    const now = formatICalDate(new Date());

    const ical = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//Julian Guggeis//Mutig für Straubing//DE',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'BEGIN:VEVENT',
      `UID:${uid}`,
      `DTSTAMP:${now}`,
      `DTSTART:${formatICalDate(startDate)}`,
      `DTEND:${formatICalDate(endDate)}`,
      `SUMMARY:${termin.titel || 'Wahlkampftermin'}`,
      `DESCRIPTION:${termin.beschreibung || ''} - Julian Guggeis (SPD)`,
      `LOCATION:${termin.ort || 'Straubing'}`,
      'ORGANIZER;CN=Julian Guggeis:mailto:info@guggeis-it.de',
      'URL:https://guggeis.org/#termine',
      'STATUS:CONFIRMED',
      'END:VEVENT',
      'END:VCALENDAR'
    ].join('\r\n');

    return ical;
  }

  // iCal-Download auslösen
  function downloadICalEvent(termin) {
    const ical = generateICalEvent(termin);
    const blob = new Blob([ical], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `guggeis-${termin.datum}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  }

  async function loadTermine() {
    const loading = document.getElementById('termine-loading');
    const grid = document.getElementById('termine-grid');
    const fallback = document.getElementById('termine-fallback');
    const mobileLoading = document.getElementById('next-event-mobile-loading');
    const mobileCard = document.getElementById('next-event-mobile-card');
    const mobileFallback = document.getElementById('next-event-mobile-fallback');
    const mobileDay = document.getElementById('next-event-mobile-day');
    const mobileMonth = document.getElementById('next-event-mobile-month');
    const mobileTitle = document.getElementById('next-event-mobile-title');
    const mobileMeta = document.getElementById('next-event-mobile-meta');
    const mobileDesc = document.getElementById('next-event-mobile-desc');

    const monthNames = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

    const showMobileFallback = () => {
      mobileLoading?.classList.add('hidden');
      mobileFallback?.classList.remove('hidden');
    };

    const showMobileCard = (termin) => {
      const dateParts = termin.datum?.split('-') || [];
      if (dateParts.length !== 3) return false;

      const monthIndex = parseInt(dateParts[1], 10) - 1;
      if (isNaN(monthIndex) || monthIndex < 0 || monthIndex > 11) return false;

      const day = dateParts[2];
      const month = monthNames[monthIndex];

      if (mobileDay) mobileDay.textContent = day;
      if (mobileMonth) mobileMonth.textContent = month;
      if (mobileTitle) mobileTitle.textContent = termin.titel || 'Treffen vor Ort';
      if (mobileMeta) mobileMeta.textContent = `${termin.uhrzeit || 'Uhrzeit folgt'} Uhr - ${termin.ort || 'Ort folgt'}`;
      if (mobileDesc) mobileDesc.textContent = termin.beschreibung || '';

      mobileLoading?.classList.add('hidden');
      mobileCard?.classList.remove('hidden');
      return true;
    };

    try {
      const response = await fetch(API_URL);

      if (!response.ok) {
        throw new Error('API nicht erreichbar');
      }

      const data = await response.json();
      const termine = data?.termine || [];

      loading?.classList.add('hidden');

      if (termine.length === 0) {
        fallback?.classList.remove('hidden');
        showMobileFallback();
        return;
      }

      const now = new Date();
      const upcoming = termine
        .map((termin) => {
          const date = new Date(`${termin.datum}T${termin.uhrzeit || '00:00'}:00`);
          return Number.isNaN(date.getTime()) ? null : { ...termin, date };
        })
        .filter(Boolean)
        .sort((a, b) => a.date - b.date)
        .find((termin) => termin.date >= now);

      if (!upcoming || !showMobileCard(upcoming)) {
        showMobileFallback();
      }

      // Termine anzeigen
      grid?.classList.remove('hidden');

      // Schema.org JSON-LD für alle Events
      const schemaEvents = [];

      termine.forEach(termin => {
        // Datum parsen (Format: "2026-01-15") mit Validierung
        const dateParts = termin.datum?.split('-') || [];
        if (dateParts.length !== 3) {
          console.warn('Ungültiges Datumsformat:', termin.datum);
          return; // Termin überspringen
        }

        const monthIndex = parseInt(dateParts[1]) - 1;
        if (isNaN(monthIndex) || monthIndex < 0 || monthIndex > 11) {
          console.warn('Ungültiger Monat:', termin.datum);
          return; // Termin überspringen
        }

        const day = dateParts[2];
        const month = monthNames[monthIndex];
        const year = dateParts[0];

        // ISO 8601 Datum für Schema.org (z.B. "2026-01-15T18:00:00")
        const startDateTime = `${termin.datum}T${termin.uhrzeit}:00`;

        // Schema.org Event-Objekt erstellen
        schemaEvents.push({
          "@type": "Event",
          "name": termin.titel,
          "description": termin.beschreibung,
          "startDate": startDateTime,
          "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
          "eventStatus": "https://schema.org/EventScheduled",
          "location": {
            "@type": "Place",
            "name": termin.ort,
            "address": {
              "@type": "PostalAddress",
              "addressLocality": "Straubing",
              "addressRegion": "Bayern",
              "addressCountry": "DE"
            }
          },
          "organizer": {
            "@type": "Person",
            "name": "Julian Guggeis",
            "url": "https://guggeis.org"
          },
          "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "EUR",
            "availability": "https://schema.org/InStock",
            "url": "https://guggeis.org/#termine"
          }
        });

        const card = document.createElement('article');
        card.className = 'bg-white/10 backdrop-blur-sm p-6 hover:bg-white/20 transition-colors';
        card.setAttribute('role', 'listitem');
        card.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 text-center">
              <span class="block text-accent-yellow font-headline text-2xl leading-none">${escapeHtml(day)}</span>
              <span class="block text-white/90 text-sm uppercase">${escapeHtml(month)} ${escapeHtml(year)}</span>
            </div>
            <div class="flex-1">
              <h3 class="font-headline text-white uppercase text-lg mb-1">${escapeHtml(termin.titel)}</h3>
              <p class="text-white/90 text-sm mb-2">${escapeHtml(termin.uhrzeit)} Uhr • ${escapeHtml(termin.ort)}</p>
              <p class="text-white/80 text-sm mb-3">${escapeHtml(termin.beschreibung)}</p>
              <button
                class="ical-btn inline-flex items-center gap-2 text-accent-yellow hover:text-white text-sm transition-colors"
                aria-label="Termin zum Kalender hinzufügen"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                Zum Kalender
              </button>
            </div>
          </div>
        `;

        // Event-Listener für iCal-Download
        const icalBtn = card.querySelector('.ical-btn');
        icalBtn?.addEventListener('click', () => downloadICalEvent(termin));

        grid?.appendChild(card);
      });

      // JSON-LD Script in Head einfügen
      if (schemaEvents.length > 0) {
        const schema = {
          "@context": "https://schema.org",
          "@graph": schemaEvents
        };
        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.textContent = JSON.stringify(schema);
        document.head.appendChild(script);
      }

    } catch (error) {
      console.warn('Termine konnten nicht geladen werden:', error);
      loading?.classList.add('hidden');
      fallback?.classList.remove('hidden');
      showMobileFallback();
    }
  }

  // Termine laden wenn DOM bereit
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadTermine);
  } else {
    loadTermine();
  }
</script>
