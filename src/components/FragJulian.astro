---
// "Frag Julian" - Interaktives Frage-Modul
// Niedrigschwellige Möglichkeit, Fragen zu stellen
// Fragen werden per Formspree gesammelt

const formspreeId = "xlddegqe"; // Gleiche ID wie Newsletter oder neue erstellen

const iconShapes = {
  wohnen: {
    paths: [
      "M3 10l9-7 9 7",
      "M5 10v9h5v-5h4v5h5v-9"
    ]
  },
  mobilitaet: {
    paths: [
      "M4 6h16v9a2 2 0 01-2 2H6a2 2 0 01-2-2V6z",
      "M4 10h16",
      "M7 6v-2h10v2"
    ],
    circles: [
      { cx: 7.5, cy: 17, r: 1.5 },
      { cx: 16.5, cy: 17, r: 1.5 }
    ]
  },
  familie: {
    paths: [
      "M7 12a3 3 0 100-6 3 3 0 000 6z",
      "M17 12a3 3 0 100-6 3 3 0 000 6z",
      "M3 20a6 6 0 0112 0",
      "M9 20a6 6 0 0112 0"
    ]
  },
  innenstadt: {
    paths: [
      "M4 20h16",
      "M6 20V6h6v14",
      "M12 20V10h6v10",
      "M8 9h2",
      "M8 12h2",
      "M14 13h2",
      "M14 16h2"
    ]
  },
  verwaltung: {
    paths: [
      "M9 4h6v2H9z",
      "M6 6h12v14H6z",
      "M9 10h6",
      "M9 14h6"
    ]
  }
};

const kategorien = [
  { id: "wohnen", iconKey: "wohnen", label: "Wohnen" },
  { id: "mobilitaet", iconKey: "mobilitaet", label: "Mobilität" },
  { id: "familie", iconKey: "familie", label: "Familie" },
  { id: "innenstadt", iconKey: "innenstadt", label: "Innenstadt" },
  { id: "verwaltung", iconKey: "verwaltung", label: "Verwaltung" },
];
---

<section id="frag-julian" class="py-14 sm:py-16 lg:py-24 bg-white">
  <div class="max-w-3xl mx-auto px-6 lg:px-12">
    <div class="text-center mb-8">
      <svg class="w-12 h-12 text-primary mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 15a4 4 0 01-4 4H8l-5 3V7a4 4 0 014-4h10a4 4 0 014 4z" />
      </svg>
      <h2 class="text-2xl sm:text-4xl text-dark mb-4">
        Frag Julian
      </h2>
      <p class="text-base sm:text-lg text-gray max-w-xl mx-auto">
        Was möchtest du wissen? Stell mir deine Frage - die besten Antworten
        veröffentliche ich in den FAQ.
      </p>
    </div>

    <!-- Formular -->
    <form
      id="frag-julian-form"
      action={`https://formspree.io/f/${formspreeId}`}
      method="POST"
      class="bg-sand p-5 sm:p-6 lg:p-8 space-y-6"
    >
      <input type="hidden" name="_subject" value="Neue Frage über Frag Julian" />

      <!-- Frage (Textarea) -->
      <div>
        <label for="frage" class="block text-sm font-medium text-dark mb-2">
          Deine Frage <span class="text-primary">*</span>
        </label>
        <div class="relative">
          <textarea
            id="frage"
            name="frage"
            rows="4"
            maxlength="500"
            required
            class="w-full px-4 py-3 bg-white border-0 text-dark placeholder-gray/50 focus:ring-2 focus:ring-primary focus:outline-none resize-none"
            placeholder="Was möchtest du wissen?"
          ></textarea>
          <span
            id="char-count"
            class="absolute bottom-3 right-3 text-xs text-gray/50"
          >
            0/500
          </span>
        </div>
      </div>

      <!-- Kategorie-Tags -->
      <div>
        <label class="block text-sm font-medium text-dark mb-3">
          Thema <span class="text-gray/50">(optional)</span>
        </label>
        <div class="flex flex-wrap gap-2">
          {kategorien.map((kat) => (
            <label class="kategorie-tag cursor-pointer">
              <input
                type="checkbox"
                name="kategorie"
                value={kat.id}
                class="sr-only peer"
              />
              <span class="inline-flex items-center gap-2 px-3 py-2 bg-white text-gray text-sm border-2 border-transparent peer-checked:border-primary peer-checked:text-primary transition-colors hover:bg-gray/5">
                <span class="inline-flex items-center justify-center w-5 h-5 text-primary" aria-hidden="true">
                  <svg
                    class="w-4 h-4"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.75"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    {iconShapes[kat.iconKey].paths.map((path) => (
                      <path d={path} />
                    ))}
                    {iconShapes[kat.iconKey].circles?.map((circle) => (
                      <circle cx={circle.cx} cy={circle.cy} r={circle.r} />
                    ))}
                  </svg>
                </span>
                <span>{kat.label}</span>
              </span>
            </label>
          ))}
        </div>
      </div>

      <!-- E-Mail (optional) -->
      <div>
        <label for="email-frage" class="block text-sm font-medium text-dark mb-2">
          E-Mail für Antwort <span class="text-gray/50">(optional)</span>
        </label>
        <input
          type="email"
          id="email-frage"
          name="email"
          class="w-full px-4 py-3 bg-white border-0 text-dark placeholder-gray/50 focus:ring-2 focus:ring-primary focus:outline-none"
          placeholder="deine@email.de"
        />
        <p class="text-xs text-gray/60 mt-1">
          Nur wenn du eine persönliche Antwort möchtest
        </p>
      </div>

      <!-- Honeypot für Spam-Schutz -->
      <input type="text" name="_gotcha" class="sr-only" tabindex="-1" autocomplete="off" aria-hidden="true" />

      <!-- Submit Button -->
      <button
        type="submit"
        id="submit-btn"
        class="btn btn-primary w-full"
      >
        <span id="btn-text">Frage absenden</span>
        <span id="btn-loading" class="hidden">
          <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Wird gesendet...
        </span>
      </button>

      <!-- DSGVO Hinweis -->
      <p class="text-xs text-gray text-center">
        Mit dem Absenden erklärst du dich mit der Verarbeitung gemäß
        <a href="/datenschutz" class="text-primary hover:underline">Datenschutzerklärung</a> einverstanden.
      </p>
    </form>

    <!-- Success Message (hidden by default) -->
    <div
      id="success-message"
      class="hidden bg-accent-teal/10 border-2 border-accent-teal p-6 text-center"
    >
      <svg class="w-10 h-10 text-accent-teal mx-auto mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M20 6L9 17l-5-5" />
      </svg>
      <h3 class="text-xl font-headline text-dark uppercase mb-2">
        Danke für deine Frage!
      </h3>
      <p class="text-gray">
        Ich lese sie mir durch und antworte so bald wie möglich.
        <span id="email-note" class="hidden">Du bekommst eine Benachrichtigung per E-Mail.</span>
      </p>
      <button
        id="ask-another"
        class="btn btn-outline mt-4"
      >
        Noch eine Frage stellen
      </button>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('frag-julian-form') as HTMLFormElement;
  const textarea = document.getElementById('frage') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const successMessage = document.getElementById('success-message');
  const emailNote = document.getElementById('email-note');
  const askAnother = document.getElementById('ask-another');
  const emailInput = document.getElementById('email-frage') as HTMLInputElement;

  // Zeichenzähler
  textarea?.addEventListener('input', () => {
    const count = textarea.value.length;
    if (charCount) {
      charCount.textContent = `${count}/500`;
      charCount.classList.toggle('text-primary', count > 450);
    }
  });

  // Form Submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Loading State
    if (btnText) btnText.classList.add('hidden');
    if (btnLoading) btnLoading.classList.remove('hidden');
    if (submitBtn) submitBtn.setAttribute('disabled', 'true');

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (response.ok) {
        // Success
        form.classList.add('hidden');
        successMessage?.classList.remove('hidden');

        // Show email note if email was provided
        if (emailInput?.value && emailNote) {
          emailNote.classList.remove('hidden');
        }
      } else {
        throw new Error('Form submission failed');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Es gab ein Problem beim Senden. Bitte versuche es erneut.');
    } finally {
      // Reset loading state
      if (btnText) btnText.classList.remove('hidden');
      if (btnLoading) btnLoading.classList.add('hidden');
      if (submitBtn) submitBtn.removeAttribute('disabled');
    }
  });

  // "Ask another" button
  askAnother?.addEventListener('click', () => {
    form?.reset();
    if (charCount) charCount.textContent = '0/500';
    form?.classList.remove('hidden');
    successMessage?.classList.add('hidden');
    if (emailNote) emailNote.classList.add('hidden');
  });
</script>
