---
// "Frag Julian" - Interaktives Frage-Modul
// Niedrigschwellige MÃ¶glichkeit, Fragen zu stellen
// Fragen werden per Formspree gesammelt

const formspreeId = "xlddegqe"; // Gleiche ID wie Newsletter oder neue erstellen

const kategorien = [
  { id: "wohnen", icon: "ğŸ ", label: "Wohnen" },
  { id: "mobilitaet", icon: "ğŸšŒ", label: "MobilitÃ¤t" },
  { id: "familie", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§", label: "Familie" },
  { id: "innenstadt", icon: "ğŸ›ï¸", label: "Innenstadt" },
  { id: "verwaltung", icon: "ğŸ“‹", label: "Verwaltung" },
];
---

<section id="frag-julian" class="py-16 lg:py-24 bg-white">
  <div class="max-w-3xl mx-auto px-6 lg:px-12">
    <div class="text-center mb-8">
      <span class="inline-block text-4xl mb-4">ğŸ’¬</span>
      <h2 class="text-3xl sm:text-4xl text-dark mb-4">
        Frag Julian
      </h2>
      <p class="text-lg text-gray max-w-xl mx-auto">
        Was mÃ¶chtest du wissen? Stell mir deine Frage â€“ die besten Antworten
        verÃ¶ffentliche ich in den FAQ.
      </p>
    </div>

    <!-- Formular -->
    <form
      id="frag-julian-form"
      action={`https://formspree.io/f/${formspreeId}`}
      method="POST"
      class="bg-sand p-6 lg:p-8 space-y-6"
    >
      <input type="hidden" name="_subject" value="Neue Frage Ã¼ber Frag Julian" />

      <!-- Frage (Textarea) -->
      <div>
        <label for="frage" class="block text-sm font-medium text-dark mb-2">
          Deine Frage <span class="text-primary">*</span>
        </label>
        <div class="relative">
          <textarea
            id="frage"
            name="frage"
            rows="4"
            maxlength="500"
            required
            class="w-full px-4 py-3 bg-white border-0 text-dark placeholder-gray/50 focus:ring-2 focus:ring-primary focus:outline-none resize-none"
            placeholder="Was mÃ¶chtest du wissen?"
          ></textarea>
          <span
            id="char-count"
            class="absolute bottom-3 right-3 text-xs text-gray/50"
          >
            0/500
          </span>
        </div>
      </div>

      <!-- Kategorie-Tags -->
      <div>
        <label class="block text-sm font-medium text-dark mb-3">
          Thema <span class="text-gray/50">(optional)</span>
        </label>
        <div class="flex flex-wrap gap-2">
          {kategorien.map((kat) => (
            <label class="kategorie-tag cursor-pointer">
              <input
                type="checkbox"
                name="kategorie"
                value={kat.id}
                class="sr-only peer"
              />
              <span class="inline-flex items-center gap-1.5 px-3 py-2 bg-white text-gray text-sm border-2 border-transparent peer-checked:border-primary peer-checked:text-primary transition-colors hover:bg-gray/5">
                <span>{kat.icon}</span>
                <span>{kat.label}</span>
              </span>
            </label>
          ))}
        </div>
      </div>

      <!-- E-Mail (optional) -->
      <div>
        <label for="email-frage" class="block text-sm font-medium text-dark mb-2">
          E-Mail fÃ¼r Antwort <span class="text-gray/50">(optional)</span>
        </label>
        <input
          type="email"
          id="email-frage"
          name="email"
          class="w-full px-4 py-3 bg-white border-0 text-dark placeholder-gray/50 focus:ring-2 focus:ring-primary focus:outline-none"
          placeholder="deine@email.de"
        />
        <p class="text-xs text-gray/60 mt-1">
          Nur wenn du eine persÃ¶nliche Antwort mÃ¶chtest
        </p>
      </div>

      <!-- Honeypot fÃ¼r Spam-Schutz -->
      <input type="text" name="_gotcha" class="sr-only" tabindex="-1" autocomplete="off" aria-hidden="true" />

      <!-- Submit Button -->
      <button
        type="submit"
        id="submit-btn"
        class="btn btn-primary w-full"
      >
        <span id="btn-text">Frage absenden</span>
        <span id="btn-loading" class="hidden">
          <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Wird gesendet...
        </span>
      </button>

      <!-- DSGVO Hinweis -->
      <p class="text-xs text-gray text-center">
        Mit dem Absenden erklÃ¤rst du dich mit der Verarbeitung gemÃ¤ÃŸ
        <a href="/datenschutz" class="text-primary hover:underline">DatenschutzerklÃ¤rung</a> einverstanden.
      </p>
    </form>

    <!-- Success Message (hidden by default) -->
    <div
      id="success-message"
      class="hidden bg-accent-teal/10 border-2 border-accent-teal p-6 text-center"
    >
      <span class="inline-block text-4xl mb-3">âœ…</span>
      <h3 class="text-xl font-headline text-dark uppercase mb-2">
        Danke fÃ¼r deine Frage!
      </h3>
      <p class="text-gray">
        Ich lese sie mir durch und antworte so bald wie mÃ¶glich.
        <span id="email-note" class="hidden">Du bekommst eine Benachrichtigung per E-Mail.</span>
      </p>
      <button
        id="ask-another"
        class="btn btn-outline mt-4"
      >
        Noch eine Frage stellen
      </button>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('frag-julian-form') as HTMLFormElement;
  const textarea = document.getElementById('frage') as HTMLTextAreaElement;
  const charCount = document.getElementById('char-count');
  const submitBtn = document.getElementById('submit-btn');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const successMessage = document.getElementById('success-message');
  const emailNote = document.getElementById('email-note');
  const askAnother = document.getElementById('ask-another');
  const emailInput = document.getElementById('email-frage') as HTMLInputElement;

  // ZeichenzÃ¤hler
  textarea?.addEventListener('input', () => {
    const count = textarea.value.length;
    if (charCount) {
      charCount.textContent = `${count}/500`;
      charCount.classList.toggle('text-primary', count > 450);
    }
  });

  // Form Submit
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Loading State
    if (btnText) btnText.classList.add('hidden');
    if (btnLoading) btnLoading.classList.remove('hidden');
    if (submitBtn) submitBtn.setAttribute('disabled', 'true');

    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (response.ok) {
        // Success
        form.classList.add('hidden');
        successMessage?.classList.remove('hidden');

        // Show email note if email was provided
        if (emailInput?.value && emailNote) {
          emailNote.classList.remove('hidden');
        }
      } else {
        throw new Error('Form submission failed');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Es gab ein Problem beim Senden. Bitte versuche es erneut.');
    } finally {
      // Reset loading state
      if (btnText) btnText.classList.remove('hidden');
      if (btnLoading) btnLoading.classList.add('hidden');
      if (submitBtn) submitBtn.removeAttribute('disabled');
    }
  });

  // "Ask another" button
  askAnother?.addEventListener('click', () => {
    form?.reset();
    if (charCount) charCount.textContent = '0/500';
    form?.classList.remove('hidden');
    successMessage?.classList.add('hidden');
    if (emailNote) emailNote.classList.add('hidden');
  });
</script>
